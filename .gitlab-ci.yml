stages:
  - build
  - test

include:
  - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/linux.yml

build-appimage:
  stage: test
  image: tallfurryman/kstars-ci:0.9
  interruptible: true
  allow_failure: true
  only:
    - merge_requests
  before_script:
    - python3 -m pip install appimage-builder
    - wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O /opt/appimagetool
    - chmod +x /opt/appimagetool
    - pushd /opt/; /opt/appimagetool --appimage-extract
    - mv /opt/squashfs-root /opt/appimagetool.AppDir
    - ln -s /opt/appimagetool.AppDir/AppRun /usr/local/bin/appimagetool
    - popd
  script:
    - add-apt-repository --remove ppa:mutlaqja/indinightly
    - add-apt-repository ppa:mutlaqja/ppa
    - apt update
    - apt -y --no-install-recommends install libindi1 libindi-dev libindi-data indi-bin xplanet gsc phd2 libstellarsolver libstellarsolver-dev
    - mkdir -p kstars-build
    - cd kstars-build
    - cmake -GNinja -DCMAKE_BUILD_TYPE=Release .. -DCCACHE_SUPPORT=ON -DBUILD_TESTING=${BUILD_TESTING:-OFF} -DBUILD_DOC=${BUILD_DOC:-OFF}
    - ninja -j8 all install
    - appimage-builder --recipe ../appimage/appimage-builder.yml --skip-test
  artifacts:
    expire_in: 1 week
    paths:
      - 'kstars-build/*.AppImage*'

